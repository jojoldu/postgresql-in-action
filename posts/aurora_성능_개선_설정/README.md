# AWS Aurora PostgreSQL 인스턴스 최적화 설정하기

AWS Aurora PostgreSQL `db.r6i.2xlarge` 인스턴스를 사용할 때 성능을 최적화하기 위한 설정을 

## 인스턴스 스펙

`db.r6i.2xlarge` 의 인스턴스는 다음과 같은 스펙을 가지고 있다.

- vCPU: 8
- 메모리: 64 GiB

이를 기준으로 설정한다.

## 주요 파라미터 설정

### 병렬 처리 설정

```sql
SET max_parallel_workers_per_gather = 4;  -- vCPU 수의 절반
SET max_parallel_workers = 8;  -- vCPU 수와 동일
```

### 메모리 관련 설정

```sql
SET work_mem = '256MB';  -- 총 메모리의 약 4%
SET shared_buffers = '16GB';  -- 총 메모리의 약 25%
SET effective_cache_size = '48GB';  -- 총 메모리의 약 75%
SET maintenance_work_mem = '2GB';
SET wal_buffers = '16MB';
```


#### 1. work_mem
work_mem은 정렬 작업이나 해시 테이블과 같은 복잡한 쿼리 작업에 사용되는 메모리 양을 지정한다.

`work_mem` 파라미터는 내부 정렬 작업과 해시 테이블이 임시 디스크 파일로 넘어가기 전에 사용할 메모리 양을 정한다. 이는 쿼리 단위가 아닌 정렬 및 해시 작업의 수에 따라 설정된다.

워크로드 특성에 따라 `work_mem` 설정을 조정해야 한다. 간단한 조인과 최소한의 정렬 작업이 포함된 단기 실행 쿼리가 많은 경우엔 낮게 설정하는 것이 좋다. 반면, 복잡한 조인 및 정렬이 포함된 활성 쿼리가 소수 있는 경우엔 높은 값으로 설정하는 것이 유리하다.

`work_mem`의 최적값을 찾는 것은 쉽지 않다. 높은 메모리 사용률이나 메모리 부족 문제가 발생하면 `work_mem` 값을 줄이는 것을 고려해야 한다.

대략적인 `work_mem` 계산 공식은 다음과 같다:
`work_mem = 전체 RAM / 최대 연결 수 / 16`

`work_mem`의 기본값은 4MB다. Azure Portal의 파라미터 페이지를 통해 서버 수준을 포함한 여러 수준에서 이 값을 설정할 수 있다.

효과적인 `work_mem` 설정 전략은 사용량이 많은 시간대의 메모리 사용량을 모니터링하는 것이다. 이 시간 동안 디스크 정렬이 발생하고 동시에 사용되지 않은 메모리가 많다면, 사용 가능한 메모리와 사용된 메모리 사이의 균형이 맞을 때까지 `work_mem`을 점진적으로 늘린다. 반대로 메모리 사용량이 과도해 보이면 `work_mem` 값을 줄인다.

이 값은 각 쿼리 실행 계획의 노드마다 할당될 수 있으므로, 너무 높게 설정하면 전체 메모리 사용량이 급증할 수 있다.
동시 실행되는 쿼리 수를 고려하여 설정해야 한다.

- 동시성 고려
  - work_mem은 쿼리 실행 계획의 각 노드마다 할당될 수 있다.
  - 여러 쿼리가 동시에 실행될 때, 각 쿼리의 여러 노드가 이 메모리를 사용할 수 있다.
  - 4%로 설정하면 여러 쿼리와 노드 간에 메모리를 균형있게 분배할 수 있다.

- 메모리 오버커밋 방지
  - 너무 높게 설정하면 동시 실행 쿼리로 인해 전체 메모리 사용량이 급증할 수 있다.
  - 4% 정도로 유지하면 메모리 오버커밋의 위험을 줄일 수 있다.

- 다른 메모리 영역과의 균형
  - shared_buffers, effective_cache_size 등 다른 중요한 메모리 영역을 위한 공간을 확보해야 한다.
  - 4%로 설정하면 이러한 다른 영역과 적절한 균형을 유지할 수 있다.

- 일반적인 워크로드에 적합
  - 대부분의 OLTP 워크로드에서 이 정도 크기면 충분한 성능을 제공할 수 있다.
  - 복잡한 정렬이나 해시 작업이 많지 않은 일반적인 쿼리 패턴에 적합하다.

- 조정의 여지
  - 4%는 시작점으로 적당하다. 
  - 필요에 따라 위아래로 조정할 수 있는 여지를 남긴다.
  - 워크로드 특성에 따라 이 값을 증가시키거나 감소시킬 수 있다.

- 시스템 안정성
  - 너무 높게 설정하면 시스템이 불안정해질 수 있다.
  - 4% 정도로 유지하면 시스템의 전반적인 안정성을 해치지 않으면서도 성능 향상을 기대할 수 있다.

#### 2. shared_buffers
shared_buffers는 PostgreSQL이 데이터 캐싱에 사용하는 메모리 양을 지정한다.

설정값: '16GB'
총 메모리의 약 25%

이 값을 늘리면 디스크 I/O를 줄일 수 있어 성능이 향상될 수 있다.
그러나 너무 크게 설정하면 운영체제의 파일 시스템 캐시에 사용할 수 있는 메모리가 줄어들 수 있다.

#### 3. effective_cache_size
effective_cache_size는 단일 쿼리에 사용할 수 있는 메모리의 양에 대한 플래너의 가정을 설정한다.

설정값: '48GB'
총 메모리의 약 75%


#### 4. maintenance_work_mem
maintenance_work_mem은 VACUUM, CREATE INDEX, ALTER TABLE ADD FOREIGN KEY 등의 유지보수 작업에 사용되는 메모리 양을 지정한다.

설정값: '2GB'

이 값을 늘리면 대규모 유지보수 작업의 성능이 향상될 수 있다.
그러나 너무 크게 설정하면 메모리 부족 문제가 발생할 수 있으므로 주의가 필요하다.

#### 5. wal_buffers
wal_buffers는 Write-Ahead Logging(WAL)에 사용되는 공유 메모리의 양을 지정한다.

설정값: '16MB'

이 값은 일반적으로 큰 영향을 미치지 않지만, 트랜잭션이 많은 워크로드에서는 약간의 성능 향상을 가져올 수 있다.
16MB 정도면 대부분의 시스템에 충분하다.

### 연결 및 Autovacuum 설정

- `max_connections`: Aurora 에서 인스턴스 스펙에 맞게 자동으로 설정을 해준다.
  - 다만, 그 이상으로 connections을 사용하고 싶다면 설정한다.
 
```sql
SET max_connections = 200;  -- 워크로드에 따라 조정
SET autovacuum_max_workers = 3;
SET autovacuum_naptime = '1min';
```

### 성능 최적화 설정

```sql
SET temp_file_limit = '5GB';
```